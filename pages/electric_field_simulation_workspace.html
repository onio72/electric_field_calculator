<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calculadora de Campo Eléctrico - Espacio de Simulación</title>
    <link rel="stylesheet" href="../css/main.css" />
    <link rel="icon" href="../public/favicon.ico">
    <link rel="manifest" href="../public/manifest.json">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <script type="module" src="https://static.rocket.new/rocket-web.js?_cfg=https%3A%2F%2Felectricf1586back.builtwithrocket.new&_be=https%3A%2F%2Fapplication.rocket.new&_v=0.1.6"></script>
</head>
<body class="bg-background min-h-screen">
    <!-- Header -->
    <header class="bg-surface shadow-subtle border-b border-secondary-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center">
                            <i class="fas fa-bolt text-white text-sm"></i>
                        </div>
                        <h1 class="text-xl font-semibold text-text-primary">Calculadora de Campo Eléctrico</h1>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button class="flex items-center space-x-2 px-3 py-2 text-sm text-secondary-600 hover:text-primary transition-colors">
                        <i class="fas fa-globe text-sm"></i>
                        <span>ES</span>
                    </button>
                    <button class="p-2 text-secondary-600 hover:text-primary transition-colors" title="Ayuda">
                        <i class="fas fa-question-circle text-lg"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Interactive Grid Section (100% width at top) -->
        <div class="w-full mb-6">
            <div class="card">
                <div class="h-full flex flex-col">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold text-text-primary">Cuadrícula Interactiva</h2>
                        <div class="flex items-center space-x-4 text-sm text-secondary-600">
                            <span>Arrastra cargas para moverlas | Rueda del ratón para zoom</span>
                            <button id="resetZoom" class="btn-secondary text-xs">
                                <i class="fas fa-search-minus mr-1"></i>
                                Reset Zoom
                            </button>
                        </div>
                    </div>
                    
                    <!-- Enhanced Grid Container with Zoom Controls -->
                    <div class="relative bg-secondary-50 rounded-lg border-2 border-secondary-200 overflow-hidden" style="height: 500px;">
                        <div id="zoomInfo" class="absolute top-4 right-4 bg-surface px-3 py-2 rounded-lg shadow-subtle border border-secondary-200 text-sm font-mono z-10">
                            Zoom: <span id="zoomLevel">100%</span>
                        </div>
                        
                        <svg id="electricFieldGrid" class="w-full h-full cursor-crosshair"
                             viewBox="0 0 600 400" preserveAspectRatio="xMidYMid meet">
                            <!-- Enhanced Grid with Dynamic Patterns -->
                            <defs>
                                <!-- 200 % 30 = 20  => desplazamos la rejilla gruesa 20px en Y -->
<pattern id="grid" width="30" height="30" patternUnits="userSpaceOnUse"
         patternTransform="translate(0,20)">
    <path d="M 30 0 L 0 0 0 30" fill="none" stroke="#CBD5E1" stroke-width="1"/>
</pattern>

<!-- 200 % 6 = 2 => desplazamos la rejilla fina 2px en Y -->
<pattern id="gridFine" width="6" height="6" patternUnits="userSpaceOnUse"
         patternTransform="translate(0,2)">
    <path d="M 6 0 L 0 0 0 6" fill="none" stroke="#E5E7EB" stroke-width="0.5"/>
</pattern>

                                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                    <polygon points="0 0, 10 3.5, 0 7" fill="#2563EB"/>
                                </marker>
                                <marker id="arrowhead-red" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                    <polygon points="0 0, 10 3.5, 0 7" fill="#DC2626"/>
                                </marker>
                                <marker id="arrowhead-green" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                    <polygon points="0 0, 10 3.5, 0 7" fill="#059669"/>
                                </marker>
                            </defs>
                            
                            <!-- Zoomable and Pannable Group -->
                            <g id="zoomGroup">
                                <!-- Fine Grid Background (for higher zoom levels) -->
                                <rect width="100%" height="100%" fill="url(#gridFine)" opacity="0" pointer-events="none"/>
                                
                                <!-- Main Grid Background -->
                                <rect width="100%" height="100%" fill="url(#grid)" pointer-events="none"/>
                                
                                <!-- Enhanced Centered Axes -->
                                <line x1="300" y1="0" x2="300" y2="400" stroke="#475569" stroke-width="2"/>
                                <line x1="0" y1="200" x2="600" y2="200" stroke="#475569" stroke-width="2"/>
                                
                                <!-- Extended Axis Labels -->
                                <text x="580" y="195" fill="#475569" font-size="14" font-weight="500">X</text>
                                <text x="305" y="15" fill="#475569" font-size="14" font-weight="500">Y</text>
                                
                                <!-- Complete Grid Coordinates - Extended to edges -->
                                <g id="gridCoordinates">
                                    <!-- Positive X-axis markers (extended) -->
                                    <text x="330" y="195" fill="#64748B" font-size="10">1</text>
                                    <text x="360" y="195" fill="#64748B" font-size="10">2</text>
                                    <text x="390" y="195" fill="#64748B" font-size="10">3</text>
                                    <text x="420" y="195" fill="#64748B" font-size="10">4</text>
                                    <text x="450" y="195" fill="#64748B" font-size="10">5</text>
                                    <text x="480" y="195" fill="#64748B" font-size="10">6</text>
                                    <text x="510" y="195" fill="#64748B" font-size="10">7</text>
                                    <text x="540" y="195" fill="#64748B" font-size="10">8</text>
                                    <text x="570" y="195" fill="#64748B" font-size="10">9</text>
                                    
                                    <!-- Negative X-axis markers (extended) -->
                                    <text x="270" y="195" fill="#64748B" font-size="10">-1</text>
                                    <text x="240" y="195" fill="#64748B" font-size="10">-2</text>
                                    <text x="210" y="195" fill="#64748B" font-size="10">-3</text>
                                    <text x="180" y="195" fill="#64748B" font-size="10">-4</text>
                                    <text x="150" y="195" fill="#64748B" font-size="10">-5</text>
                                    <text x="120" y="195" fill="#64748B" font-size="10">-6</text>
                                    <text x="90"  y="195" fill="#64748B" font-size="10">-7</text>
                                    <text x="60"  y="195" fill="#64748B" font-size="10">-8</text>
                                    <text x="30"  y="195" fill="#64748B" font-size="10">-9</text>
                                    
                                    <!-- Positive Y-axis markers (extended) -->
                                    <text x="305" y="170" fill="#64748B" font-size="10">1</text>
                                    <text x="305" y="140" fill="#64748B" font-size="10">2</text>
                                    <text x="305" y="110" fill="#64748B" font-size="10">3</text>
                                    <text x="305" y="80"  fill="#64748B" font-size="10">4</text>
                                    <text x="305" y="50"  fill="#64748B" font-size="10">5</text>
                                    <text x="305" y="20"  fill="#64748B" font-size="10">6</text>
                                    
                                    <!-- Negative Y-axis markers (extended) -->
                                    <text x="305" y="230" fill="#64748B" font-size="10">-1</text>
                                    <text x="305" y="260" fill="#64748B" font-size="10">-2</text>
                                    <text x="305" y="290" fill="#64748B" font-size="10">-3</text>
                                    <text x="305" y="320" fill="#64748B" font-size="10">-4</text>
                                    <text x="305" y="350" fill="#64748B" font-size="10">-5</text>
                                    <text x="305" y="380" fill="#64748B" font-size="10">-6</text>
                                </g>
                                
                                <!-- Interactive Elements -->
                                <g id="charges"></g>
                                <g id="vectors"></g>
                                <g id="testPoint"></g>
                            </g>
                        </svg>
                        
                        <!-- Enhanced Coordinate Display -->
                        <div id="coordinateDisplay" class="absolute top-4 left-4 bg-surface px-3 py-2 rounded-lg shadow-subtle border border-secondary-200 text-sm font-mono opacity-0 transition-opacity">
                            <span id="currentCoords">X: 0, Y: 0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Controls Section (33.33% each, below grid) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Charge Q₁ Controls with Coordinate Editing -->
            <div class="card">
                <h3 class="text-md font-semibold text-text-primary mb-3 flex items-center">
                    <div class="w-3 h-3 bg-success rounded-full mr-2"></div>
                    Carga Q₁
                </h3>
                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Valor</label>
                             <input type="number" id="q1Value" class="input-field text-sm" placeholder="5.0" value="5.0" step="0.1" min="0" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Unidades</label>
                            <select id="q1Units" class="input-field text-sm">
                                <option value="nC">nC</option>
                                <option value="μC">μC</option>
                                <option value="C">C</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-text-secondary mb-1">Polaridad</label>
                        <select id="q1Polarity" class="input-field text-sm">
                            <option value="positive" selected>Positiva (+)</option>
                            <option value="negative">Negativa (-)</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Coordenadas</label>
                            <input type="number" id="q1CoordX" class="coordinate-input" placeholder="x" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1 invisible">.</label>
                            <input type="number" id="q1CoordY" class="coordinate-input" placeholder="y" />
                        </div>
                    </div>
                    <button id="updateQ1Position" class="btn-secondary w-full text-xs">
                        <i class="fas fa-map-marker-alt mr-1"></i>
                        Actualizar Posición
                    </button>
                    <div class="text-xs text-secondary-600">
                        <span id="q1Position">Posición: No colocada</span>
                    </div>
                </div>
            </div>

            <!-- Charge Q₂ Controls with Coordinate Editing -->
            <div class="card">
                <h3 class="text-md font-semibold text-text-primary mb-3 flex items-center">
                    <div class="w-3 h-3 bg-accent rounded-full mr-2"></div>
                    Carga Q₂
                </h3>
                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Valor</label>
                            <input type="number" id="q2Value" class="input-field text-sm" placeholder="3.0" value="3.0" step="0.1" min="0" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Unidades</label>
                            <select id="q2Units" class="input-field text-sm">
                                <option value="nC">nC</option>
                                <option value="μC">μC</option>
                                <option value="C">C</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-text-secondary mb-1">Polaridad</label>
                        <select id="q2Polarity" class="input-field text-sm">
                            <option value="positive">Positiva (+)</option>
                            <option value="negative" selected>Negativa (-)</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Coordenadas</label>
                            <input type="number" id="q2CoordX" class="coordinate-input" placeholder="x" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1 invisible">.</label>
                            <input type="number" id="q2CoordY" class="coordinate-input" placeholder="y" />
                        </div>
                    </div>
                    <button id="updateQ2Position" class="btn-secondary w-full text-xs">
                        <i class="fas fa-map-marker-alt mr-1"></i>
                        Actualizar Posición
                    </button>
                    <div class="text-xs text-secondary-600">
                        <span id="q2Position">Posición: No colocada</span>
                    </div>
                </div>
            </div>

            <!-- Test Point Controls -->
            <div class="card">
                <h3 class="text-md font-semibold text-text-primary mb-3 flex items-center">
                    <div class="w-3 h-3 bg-primary rounded-full mr-2"></div>
                    Punto de Testeo del Campo
                </h3>
                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Coordenadas</label>
                            <input type="number" id="testPointCoordX" class="coordinate-input" placeholder="x" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1 invisible">.</label>
                            <input type="number" id="testPointCoordY" class="coordinate-input" placeholder="y" />
                        </div>
                    </div>
                    <button id="updateTestPointPosition" class="btn-secondary w-full text-xs">
                        <i class="fas fa-crosshairs mr-1"></i>
                        Actualizar Punto
                    </button>
                    
                    <div class="text-xs text-secondary-600">
                        <span id="testPointPosition">Posición: No seleccionado</span>
                    </div>
                    <div class="flex gap-2">
                        <button id="clearAll" class="flex-1 btn-secondary text-xs">
                            <i class="fas fa-trash-alt mr-1"></i>
                            Limpiar
                        </button>
                        <button id="autoPlace" class="flex-1 btn-secondary text-xs">
                            <i class="fas fa-magic mr-1"></i>
                            Auto
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calculations Panel (Full Width, Below controls) -->
        <div class="w-full">
            <div class="card">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-text-primary">Cálculos Matemáticos</h2>
                    <div class="flex items-center space-x-2">
                        <button id="toggleCalculations" class="btn-secondary text-sm">
                            <i class="fas fa-chevron-up"></i>
                            <span class="hidden sm:inline ml-2">Contraer</span>
                        </button>
                    </div>
                </div>
                
                <div id="calculationsContent" class="overflow-y-auto">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- Position Vectors -->
                        <div class="bg-secondary-50 rounded-lg p-4">
                            <h3 class="text-sm font-semibold text-text-primary mb-3 flex items-center">
                                <i class="fas fa-vector-square text-primary mr-2"></i>
                                Vectores de Posición
                            </h3>
                            <div class="space-y-2 text-sm font-mono">
                                <div>r₁ = <span id="r1Vector">No calculado</span></div>
                                <div>r₂ = <span id="r2Vector">No calculado</span></div>
                                <div class="pt-2 border-t border-secondary-200">|r₁| = <span id="r1Magnitude">No calculado</span></div>
                                <div>|r₂| = <span id="r2Magnitude">No calculado</span></div>
                            </div>
                        </div>

                        <!-- Unit Vectors -->
                        <div class="bg-secondary-50 rounded-lg p-4">
                            <h3 class="text-sm font-semibold text-text-primary mb-3 flex items-center">
                                <i class="fas fa-compass text-success mr-2"></i>
                                Vectores Unitarios
                            </h3>
                            <div class="space-y-2 text-sm font-mono">
                                <div>û₁ = <span id="u1Vector">No calculado</span></div>
                                <div>û₂ = <span id="u2Vector">No calculado</span></div>
                            </div>
                        </div>

                        <!-- Electric Fields -->
                        <div class="bg-secondary-50 rounded-lg p-4">
                            <h3 class="text-sm font-semibold text-text-primary mb-3 flex items-center">
                                <i class="fas fa-bolt text-warning mr-2"></i>
                                Campos Eléctricos
                            </h3>
                            <div class="space-y-2 text-sm font-mono">
                                <div>|E₁| = <span id="e1Magnitude">No calculado</span></div>
                                <div>|E₂| = <span id="e2Magnitude">No calculado</span></div>
                                <div class="pt-2 border-t border-secondary-200">E₁ = <span id="e1Vector">No calculado</span></div>
                                <div>E₂ = <span id="e2Vector">No calculado</span></div>
                            </div>
                        </div>

                        <!-- Total Field -->
                        <div class="bg-secondary-50 rounded-lg p-4">
                            <h3 class="text-sm font-semibold text-text-primary mb-3 flex items-center">
                                <i class="fas fa-plus text-primary mr-2"></i>
                                Campo Total
                            </h3>
                            <div class="space-y-2 text-sm font-mono">
                                <div>E_total = <span id="eTotalVector">No calculado</span></div>
                                <div>|E_total| = <span id="eTotalMagnitude">No calculado</span></div>
                            </div>
                            <div class="mt-3 space-y-1 text-xs text-secondary-600">
                                <div class="flex items-center"><div class="w-3 h-1 bg-red-600 mr-2"></div><span>E₁ (Rojo - Positivo)</span></div>
                                <div class="flex items-center"><div class="w-3 h-1 bg-blue-600 mr-2"></div><span>E₂ (Azul - Negativo)</span></div>
                                <div class="flex items-center"><div class="w-3 h-1 bg-primary mr-2"></div><span>E_total (Azul)</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Instructions Modal (Updated) -->
    <div id="instructionsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-surface rounded-xl shadow-medium max-w-2xl w-full max-h-[80vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-text-primary">Instrucciones de Uso</h2>
                    <button id="closeInstructions" class="text-secondary-600 hover:text-text-primary">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div class="space-y-4 text-sm text-text-secondary">
                    <div>
                        <h3 class="font-semibold text-text-primary mb-2">1. Colocar y Editar Cargas</h3>
                        <p>Haz clic en la cuadrícula para colocar cargas o usa los campos de coordenadas para posicionarlas exactamente. Arrastra las cargas para moverlas interactivamente.</p>
                    </div>
                    <div>
                        <h3 class="font-semibold text-text-primary mb-2">2. Navegación y Zoom</h3>
                        <p>Usa la rueda del ratón para hacer zoom. Los ejes están centrados con numeración completa hasta los bordes visibles.</p>
                    </div>
                    <div>
                        <h3 class="font-semibold text-text-primary mb-2">3. Cálculo del Campo</h3>
                        <p>Coloca el punto de cálculo haciendo clic o editando sus coordenadas. Los resultados aparecen en el panel separado de cálculos.</p>
                    </div>
                    <div>
                        <h3 class="font-semibold text-text-primary mb-2">4. Interfaz Mejorada</h3>
                        <p>El panel de cuadrícula y el de cálculos están separados para evitar solapamientos y mejorar la visualización.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Enhanced Electric Field Calculator with Interactive Features
        class ElectricFieldCalculator {
            constructor() {
                this.svg = document.getElementById('electricFieldGrid');
                this.zoomGroup = document.getElementById('zoomGroup');
                this.charges = { q1: null, q2: null };
                this.testPoint = null;
                this.k = 8.99e9; // Coulomb's constant
                this.scale = 30; // pixels per unit
                this.centerX = 300;
                this.centerY = 200;
                this.currentStep = 'q1'; // q1, q2, testPoint
                
                // Zoom and drag properties
                this.zoomLevel = 1;
                this.zoomMin = 0.5;
                this.zoomMax = 3;
                this.isDragging = false;
                this.dragTarget = null;
                this.dragOffset = { x: 0, y: 0 };
                
                this.initializeEventListeners();
                this.showInstructions();
                // Aplicar el zoom inicial centrado
                this.updateZoom();
            }

            initializeEventListeners() {
                // Enhanced grid interaction
                this.svg.addEventListener('click', (e) => this.handleGridClick(e));
                this.svg.addEventListener('mousedown', (e) => this.handleMouseDown(e));
                this.svg.addEventListener('mousemove', (e) => this.handleMouseMove(e));
                this.svg.addEventListener('mouseup', (e) => this.handleMouseUp(e));
                this.svg.addEventListener('mouseleave', (e) => this.handleMouseLeave(e));
                
                // Zoom functionality
                this.svg.addEventListener('wheel', (e) => this.handleZoom(e));
                
                // Mouse move for coordinate display
                this.svg.addEventListener('mousemove', (e) => this.updateCoordinateDisplay(e));

                // Control panel listeners with charge visualization update
                ['q1Value', 'q1Units'].forEach(id => {
 document.getElementById(id).addEventListener('change', () => this.updateCalculations());
});
['q2Value', 'q2Units'].forEach(id => {
document.getElementById(id).addEventListener('change', () => this.updateCalculations());
});

// Forzar que q1Value y q2Value nunca queden negativos
['q1Value','q2Value'].forEach(id => {
const el = document.getElementById(id);
el.addEventListener('input', () => {
 if (el.value < 0) el.value = Math.abs(el.value);
        });
        });

                // Add polarity change listeners to update charge visualization
                document.getElementById('q1Polarity').addEventListener('change', () => {
                    if (this.charges.q1) {
                        this.updateChargeVisual('q1', this.charges.q1.x, this.charges.q1.y);
                    }
                    this.updateCalculations();
                });
                document.getElementById('q2Polarity').addEventListener('change', () => {
                    if (this.charges.q2) {
                        this.updateChargeVisual('q2', this.charges.q2.x, this.charges.q2.y);
                    }
                    this.updateCalculations();
                });

                // Coordinate input listeners
                document.getElementById('updateQ1Position').addEventListener('click', () => this.updateChargeFromCoords('q1'));
                document.getElementById('updateQ2Position').addEventListener('click', () => this.updateChargeFromCoords('q2'));
                document.getElementById('updateTestPointPosition').addEventListener('click', () => this.updateTestPointFromCoords());

                // Enhanced buttons
                document.getElementById('clearAll').addEventListener('click', () => this.clearAll());
                document.getElementById('autoPlace').addEventListener('click', () => this.autoPlaceCharges());
                document.getElementById('resetZoom').addEventListener('click', () => this.resetZoom());

                // Instructions modal
                document.querySelector('[title="Ayuda"]').addEventListener('click', () => this.showInstructions());
                document.getElementById('closeInstructions').addEventListener('click', () => this.hideInstructions());

                // Enhanced calculations toggle
                document.getElementById('toggleCalculations').addEventListener('click', () => this.toggleCalculations());
            }

            handleGridClick(e) {
                if (this.isDragging) return;
                
                const coords = this.getCoordinatesFromEvent(e);
                
                if (this.currentStep === 'q1' && !this.charges.q1) {
                    this.placeCharge('q1', coords.x, coords.y);
                    this.currentStep = 'q2';
                } else if (this.currentStep === 'q2' && !this.charges.q2) {
                    this.placeCharge('q2', coords.x, coords.y);
                    this.currentStep = 'testPoint';
                } else if (this.currentStep === 'testPoint' && this.charges.q1 && this.charges.q2) {
                    this.placeTestPoint(coords.x, coords.y);
                    this.updateCalculations();
                }
            }

            handleMouseDown(e) {
                const target = e.target.closest('[id^="charge-"]');
                if (target) {
                    this.isDragging = true;
                    this.dragTarget = target.id.split('-')[1]; // Extract charge ID
                    const coords = this.getCoordinatesFromEvent(e);
                    const charge = this.charges[this.dragTarget];
                    this.dragOffset.x = coords.x - charge.x;
                    this.dragOffset.y = coords.y - charge.y;
                    this.svg.style.cursor = 'grabbing';
                    e.preventDefault();
                }
            }

            handleMouseMove(e) {
                if (this.isDragging && this.dragTarget) {
                    const coords = this.getCoordinatesFromEvent(e);
                    const newX = coords.x - this.dragOffset.x;
                    const newY = coords.y - this.dragOffset.y;
                    
                    // Update charge position
                    this.charges[this.dragTarget] = { x: newX, y: newY };
                    this.updateChargeVisual(this.dragTarget, newX, newY);
                    this.updatePositionDisplay(this.dragTarget, newX, newY);
                    this.updateCoordinateInputs(this.dragTarget, newX, newY);
                    
                    if (this.testPoint) {
                        this.updateCalculations();
                    }
                } else {
                    // Update cursor for draggable elements
                    const target = e.target.closest('[id^="charge-"]');
                    this.svg.style.cursor = target ? 'grab' : 'crosshair';
                }
                
                this.updateCoordinateDisplay(e);
            }

            handleMouseUp(e) {
                if (this.isDragging) {
                    this.isDragging = false;
                    this.dragTarget = null;
                    this.svg.style.cursor = 'crosshair';
                }
            }

            handleMouseLeave(e) {
                this.handleMouseUp(e);
                document.getElementById('coordinateDisplay').style.opacity = '0';
            }

            handleZoom(e) {
                e.preventDefault();
                
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                const newZoom = Math.max(this.zoomMin, Math.min(this.zoomMax, this.zoomLevel + delta));
                
                if (newZoom !== this.zoomLevel) {
                    this.zoomLevel = newZoom;
                    this.updateZoom();
                }
            }

            updateZoom() {
                const cx = this.centerX;
                const cy = this.centerY;
                const z  = this.zoomLevel;

                // Escalado alrededor del centro: T(cx,cy) · S(z) · T(-cx,-cy)
                this.zoomGroup.setAttribute('transform', `translate(${cx} ${cy}) scale(${z}) translate(${-cx} ${-cy})`);

                document.getElementById('zoomLevel').textContent = `${Math.round(z * 100)}%`;

                // Mostrar/ocultar cuadrícula fina
                const fineGrid = this.svg.querySelector('rect[fill="url(#gridFine)"]');
                if (fineGrid) fineGrid.setAttribute('opacity', z > 1.5 ? '1' : '0');
            }

            resetZoom() {
                this.zoomLevel = 1;
                this.updateZoom();
            }

            getCoordinatesFromEvent(e) {
                const pt = this.svg.createSVGPoint();
                pt.x = e.clientX;
                pt.y = e.clientY;
                const local = pt.matrixTransform(this.zoomGroup.getScreenCTM().inverse());
                const x = (local.x - this.centerX) / this.scale;
                const y = -(local.y - this.centerY) / this.scale;
                return { x, y };
            }

            updateChargeFromCoords(chargeId) {
                const xInput = document.getElementById(`${chargeId}CoordX`);
                const yInput = document.getElementById(`${chargeId}CoordY`);
                
                const x = parseFloat(xInput.value);
                const y = parseFloat(yInput.value);
                
                if (!isNaN(x) && !isNaN(y)) {
                    this.placeCharge(chargeId, x, y);
                    if (this.testPoint) {
                        this.updateCalculations();
                    }
                }
            }

            updateTestPointFromCoords() {
                const xInput = document.getElementById('testPointCoordX');
                const yInput = document.getElementById('testPointCoordY');
                
                const x = parseFloat(xInput.value);
                const y = parseFloat(yInput.value);
                
                if (!isNaN(x) && !isNaN(y)) {
                    this.placeTestPoint(x, y);
                    this.updateCalculations();
                }
            }

            updateCoordinateInputs(chargeId, x, y) {
                document.getElementById(`${chargeId}CoordX`).value = x.toFixed(1);
                document.getElementById(`${chargeId}CoordY`).value = y.toFixed(1);
            }

            autoPlaceCharges() {
                // Auto-place charges in a symmetric configuration
                this.placeCharge('q1', -2, 1);
                this.placeCharge('q2', 2, -1);
                this.placeTestPoint(0, 0);
                this.currentStep = 'testPoint';
                this.updateCalculations();
            }

            placeCharge(chargeId, x, y) {
                this.charges[chargeId] = { x, y };
                
                // Update position display
                this.updatePositionDisplay(chargeId, x, y);
                this.updateCoordinateInputs(chargeId, x, y);

                // Visual representation
                this.updateChargeVisual(chargeId, x, y);
            }

            placeTestPoint(x, y) {
                this.testPoint = { x, y };
                document.getElementById('testPointPosition').textContent = 
                    `Posición: (${x.toFixed(1)}, ${y.toFixed(1)})`;
                
                // Update coordinate inputs
                document.getElementById('testPointCoordX').value = x.toFixed(1);
                document.getElementById('testPointCoordY').value = y.toFixed(1);
                
                this.updateTestPointVisual(x, y);
            }

            updatePositionDisplay(chargeId, x, y) {
                document.getElementById(`${chargeId}Position`).textContent = 
                    `Posición: (${x.toFixed(1)}, ${y.toFixed(1)})`;
            }

            updateChargeVisual(chargeId, x, y) {
                const svgX = this.centerX + x * this.scale;
                const svgY = this.centerY - y * this.scale;
                
                const chargesGroup = document.getElementById('charges');
                const existingCharge = document.getElementById(`charge-${chargeId}`);
                if (existingCharge) existingCharge.remove();

                // Get polarity from the dropdown to determine color and symbol
                const chargePolarity = document.getElementById(`${chargeId}Polarity`).value;
                const color = chargePolarity === 'positive' ? '#DC2626' : '#2563EB';
                const symbol = chargePolarity === 'positive' ? '' : '-';

                const chargeGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                chargeGroup.id = `charge-${chargeId}`;
                chargeGroup.style.cursor = 'grab';

                // Enhanced charge visualization with hover effects
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', svgX);
                circle.setAttribute('cy', svgY);
                circle.setAttribute('r', '12');
                circle.setAttribute('fill', color);
                circle.setAttribute('stroke', '#ffffff');
                circle.setAttribute('stroke-width', '2');
                circle.setAttribute('class', 'transition-all hover:r-14');

                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', svgX);
                text.setAttribute('y', svgY + 5);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('fill', 'white');
                text.setAttribute('font-size', '14');
                text.setAttribute('font-weight', 'bold');
                text.textContent = symbol;

                const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                label.setAttribute('x', svgX);
                label.setAttribute('y', svgY - 18);
                label.setAttribute('text-anchor', 'middle');
                label.setAttribute('fill', color);
                label.setAttribute('font-size', '12');
                label.setAttribute('font-weight', 'bold');
                label.textContent = chargeId === 'q1' ? 'Q₁' : 'Q₂';

                chargeGroup.appendChild(circle);
                chargeGroup.appendChild(text);
                chargeGroup.appendChild(label);
                chargesGroup.appendChild(chargeGroup);
            }

            updateTestPointVisual(x, y) {
                const svgX = this.centerX + x * this.scale;
                const svgY = this.centerY - y * this.scale;
                
                const testPointGroup = document.getElementById('testPoint');
                testPointGroup.innerHTML = '';

                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', svgX);
                circle.setAttribute('cy', svgY);
                circle.setAttribute('r', '6');
                circle.setAttribute('fill', '#2563EB');
                circle.setAttribute('stroke', '#ffffff');
                circle.setAttribute('stroke-width', '2');

                const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                label.setAttribute('x', svgX);
                label.setAttribute('y', svgY - 15);
                label.setAttribute('text-anchor', 'middle');
                label.setAttribute('fill', '#2563EB');
                label.setAttribute('font-size', '10');
                label.setAttribute('font-weight', 'bold');
                label.textContent = 'P';

                testPointGroup.appendChild(circle);
                testPointGroup.appendChild(label);
            }

            updateCalculations() {
                if (!this.charges.q1 || !this.charges.q2 || !this.testPoint) return;

                const q1 = this.getChargeValue('q1');
                const q2 = this.getChargeValue('q2');

                // Position vectors from charges to test point
                const r1 = {
                    x: this.testPoint.x - this.charges.q1.x,
                    y: this.testPoint.y - this.charges.q1.y
                };
                const r2 = {
                    x: this.testPoint.x - this.charges.q2.x,
                    y: this.testPoint.y - this.charges.q2.y
                };

                // Magnitudes
                const r1Mag = Math.sqrt(r1.x * r1.x + r1.y * r1.y);
                const r2Mag = Math.sqrt(r2.x * r2.x + r2.y * r2.y);

                // Unit vectors pointing from charges to test point
                const u1 = { x: r1.x / r1Mag, y: r1.y / r1Mag };
                const u2 = { x: r2.x / r2Mag, y: r2.y / r2Mag };

                // Electric field magnitudes
                const e1Mag = this.k * Math.abs(q1) / (r1Mag * r1Mag);
                const e2Mag = this.k * Math.abs(q2) / (r2Mag * r2Mag);

                // Electric field vectors with correct physics
                const e1 = {
                    x: e1Mag * u1.x * (q1 > 0 ? 1 : -1),
                    y: e1Mag * u1.y * (q1 > 0 ? 1 : -1)
                };
                const e2 = {
                    x: e2Mag * u2.x * (q2 > 0 ? 1 : -1),
                    y: e2Mag * u2.y * (q2 > 0 ? 1 : -1)
                };

                // Total field
                const eTotal = { x: e1.x + e2.x, y: e1.y + e2.y };
                const eTotalMag = Math.sqrt(eTotal.x * eTotal.x + eTotal.y * eTotal.y);

                // Update UI
                document.getElementById('r1Vector').textContent = `(${r1.x.toFixed(2)}, ${r1.y.toFixed(2)}) m`;
                document.getElementById('r2Vector').textContent = `(${r2.x.toFixed(2)}, ${r2.y.toFixed(2)}) m`;
                document.getElementById('r1Magnitude').textContent = r1Mag.toFixed(2) + ' m';
                document.getElementById('r2Magnitude').textContent = r2Mag.toFixed(2) + ' m';

                document.getElementById('u1Vector').textContent = `(${u1.x.toFixed(3)}, ${u1.y.toFixed(3)})`;
                document.getElementById('u2Vector').textContent = `(${u2.x.toFixed(3)}, ${u2.y.toFixed(3)})`;

                document.getElementById('e1Magnitude').textContent = `${e1Mag.toExponential(2)} N/C`;
                document.getElementById('e2Magnitude').textContent = `${e2Mag.toExponential(2)} N/C`;
                document.getElementById('e1Vector').textContent = `(${e1.x.toExponential(2)}, ${e1.y.toExponential(2)}) N/C`;
                document.getElementById('e2Vector').textContent = `(${e2.x.toExponential(2)}, ${e2.y.toExponential(2)}) N/C`;

                document.getElementById('eTotalVector').textContent = `(${eTotal.x.toExponential(2)}, ${eTotal.y.toExponential(2)}) N/C`;
                document.getElementById('eTotalMagnitude').textContent = `${eTotalMag.toExponential(2)} N/C`;

                // Update vectors on SVG
                this.updateVectorVisuals(e1, e2, eTotal);
            }

            updateVectorVisuals(e1, e2, eTotal) {
                const vectorsGroup = document.getElementById('vectors');
                vectorsGroup.innerHTML = '';

                const testSvgX = this.centerX + this.testPoint.x * this.scale;
                const testSvgY = this.centerY - this.testPoint.y * this.scale;

                // Scale factor for vector display
                const scaleFactor = 50 / this.zoomLevel; // Adjust for zoom

                // Draw E1 vector with color matching charge polarity
                const q1Polarity = document.getElementById('q1Polarity').value;
                const e1Color = q1Polarity === 'positive' ? '#DC2626' : '#2563EB';
                this.drawVector(vectorsGroup, testSvgX, testSvgY, e1.x * scaleFactor, -e1.y * scaleFactor, e1Color, 'arrowhead-red');
                
                // Draw E2 vector with color matching charge polarity  
                const q2Polarity = document.getElementById('q2Polarity').value;
                const e2Color = q2Polarity === 'positive' ? '#DC2626' : '#2563EB';
                this.drawVector(vectorsGroup, testSvgX, testSvgY, e2.x * scaleFactor, -e2.y * scaleFactor, e2Color, 'arrowhead-red');
                
                // Draw total vector (blue)
                this.drawVector(vectorsGroup, testSvgX, testSvgY, eTotal.x * scaleFactor, -eTotal.y * scaleFactor, '#2563EB', 'arrowhead', 3);
            }

            drawVector(group, startX, startY, dx, dy, color, markerEnd, strokeWidth = 2) {
                const length = Math.sqrt(dx * dx + dy * dy);
                if (length < 5) return; // Don't draw very small vectors

                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', startX);
                line.setAttribute('y1', startY);
                line.setAttribute('x2', startX + dx);
                line.setAttribute('y2', startY + dy);
                line.setAttribute('stroke', color);
                line.setAttribute('stroke-width', strokeWidth);
                line.setAttribute('marker-end', `url(#${markerEnd})`);
                
                group.appendChild(line);
            }

            getChargeValue(chargeId) {
                // El usuario introduce el valor absoluto; garantizamos positivo
                const value = Math.abs(parseFloat(document.getElementById(`${chargeId}Value`).value) || 0);
                 const polarity = document.getElementById(`${chargeId}Polarity`).value;
                 const units = document.getElementById(`${chargeId}Units`).value;
                 
                 let multiplier = 1;
                 switch (units) {
                     case 'nC': multiplier = 1e-9; break;
                     case 'μC': multiplier = 1e-6; break;
                     case 'C': multiplier = 1; break;
                 }
                const polarity = document.getElementById(`${chargeId}Polarity`).value;
                const units = document.getElementById(`${chargeId}Units`).value;
                
                let multiplier = 1;
                switch (units) {
                    case 'nC': multiplier = 1e-9; break;
                    case 'μC': multiplier = 1e-6; break;
                    case 'C': multiplier = 1; break;
                }
                
                // q = ±valor_abs * factor_unidades
    return value * multiplier * (polarity === 'negative' ? -1 : 1);
             
            }

            updateCoordinateDisplay(e) {
                const coords = this.getCoordinatesFromEvent(e);
                document.getElementById('currentCoords').textContent = `X: ${coords.x.toFixed(1)}, Y: ${coords.y.toFixed(1)}`;
                document.getElementById('coordinateDisplay').style.opacity = '1';
            }

            clearAll() {
                this.charges = { q1: null, q2: null };
                this.testPoint = null;
                this.currentStep = 'q1';
                
                document.getElementById('charges').innerHTML = '';
                document.getElementById('vectors').innerHTML = '';
                document.getElementById('testPoint').innerHTML = '';
                
                // Clear coordinate inputs
                ['q1CoordX', 'q1CoordY', 'q2CoordX', 'q2CoordY', 'testPointCoordX', 'testPointCoordY'].forEach(id => {
                    document.getElementById(id).value = '';
                });
                
                document.getElementById('q1Position').textContent = 'Posición: No colocada';
                document.getElementById('q2Position').textContent = 'Posición: No colocada';
                document.getElementById('testPointPosition').textContent = 'Posición: No seleccionado';
                
                // Reset calculations
                ['r1Vector', 'r2Vector', 'r1Magnitude', 'r2Magnitude', 'u1Vector', 'u2Vector', 
                 'e1Magnitude', 'e2Magnitude', 'e1Vector', 'e2Vector', 'eTotalVector', 'eTotalMagnitude'].forEach(id => {
                    document.getElementById(id).textContent = 'No calculado';
                });
            }

            showInstructions() {
                document.getElementById('instructionsModal').classList.remove('hidden');
            }

            hideInstructions() {
                document.getElementById('instructionsModal').classList.add('hidden');
            }

            toggleCalculations() {
                const content = document.getElementById('calculationsContent');
                const button = document.getElementById('toggleCalculations');
                const icon = button.querySelector('i');
                const text = button.querySelector('span');
                
                if (content.style.display === 'none') {
                    content.style.display = 'block';
                    icon.className = 'fas fa-chevron-up';
                    if (text) text.textContent = 'Contraer';
                } else {
                    content.style.display = 'none';
                    icon.className = 'fas fa-chevron-down';
                    if (text) text.textContent = 'Expandir';
                }
            }
        }

        // Initialize the enhanced calculator when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new ElectricFieldCalculator();
        });
    </script>
    <!-- Eliminado: script propio de Rocket (no existe en GitHub Pages) -->
</body>
</html>
